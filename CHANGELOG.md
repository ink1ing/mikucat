# Changelog

All notable changes to this project will be documented in this file.

## [1.2.0] - 2025-09-08

### 新增
- 沿挂「紧贴补偿(px)」：在偏好设置 → 沿挂 中新增可调补偿（默认 12px，范围 0–32）。每 +1px，沿挂 miku 向右平移 1px，用于消除素材透明边造成的视觉缝隙。
- 保存设置按钮：偏好页右下角新增「保存设置」，一键持久化当前参数到用户默认；应用启动时自动加载上次保存。

### 体验
- 偏好页重构：沿挂/太空两页统一使用 NSBox+NSGridView 的三列布局（标签/滑杆/数值），对齐规范，易读易用。
- 紧贴补偿「即时生效」：
  - 初次贴边、拖拽吸附、重置位置与落地恢复时均使用补偿，并允许补偿越过右缘；
  - 在补偿值变更时，沿挂 miku 立即贴到右侧并进行像素级对齐（Retina 下 1px≈0.5pt 也会生效）。

### 行为调整（太空模式）
- 保持运动：取消因点击其它窗口或应用失焦而自动暂停/停表的行为（你仍可单击太空 miku 暂停/继续，双击分裂）。

### 修复
- 首次启动未应用补偿：修复了初次贴边使用旧上限导致补偿被抵消的问题；现在启动即按默认/已保存的补偿生效。
- 落地后补偿丢失：进入落地状态后会重新按补偿对齐，确保与贴边视觉一致。

### 开发者笔记
- 新增 AppSettings 的持久化方法：saveToDefaults()/loadFromDefaults()。
- 新增通知 edgeVisualParamsChangedNotification，沿挂窗口监听以实时响应补偿变更。

—

## [1.1.0] - 2025-09-07

### 亮点（特色）
- 沿挂模式：贴右侧边缘、可拖拽、释放后自由落体（可配置重力/弹力）。
- 太空模式：无重力弹跳、支持多窗口相互碰撞与分裂（双击）。
- 多屏支持：可在“内置/扩展”屏幕范围内运行并自动夹取到可见区域。
- 可调帧率：30/48/50/60/120 FPS，随改随生效。
- 菜单栏控制：可见性切换、重置位置、偏好设置、关于/退出。

### 修复（稳定性）
- 修复在切换“可见/不可见”时的崩溃：
  - 改为“隐藏不销毁”（orderOut/orderFront），避免关闭窗口后异步回调继续访问窗口。
  - 菜单点击仅修改期望状态，菜单关闭后统一应用，彻底规避 NSMenu 跟踪期间的 UI 重入。
  - Space 物理更新使用窗口快照，避免帧内数组被修改导致越界或对已关闭对象写入。
  - Edge 窗口关闭前停止计时器并解除监听，避免关闭后 setFrame。
- 修复初始贴边与随机 Y 在异常屏幕布局下可能使用 NaN/Infinite 导致的崩溃。

### 优化（性能）
- 活动状态感知：App 退到后台自动暂停物理计时器，回到前台再恢复。
- 仅在“太空 miku 可见”且有窗口时运行全局物理计时器。
- 边界吸附与运动采用安全夹取，避免频繁回弹造成多余计算。

### 改进（体验）
- “关于”对话框使用 Info.plist 的版本号动态展示。
- 重置与吸附的动画更平滑，并在边界极端条件下保持稳定。

### 代码结构
- AppDelegate：
  - 引入 NSMenuDelegate，在 menuDidClose 中统一应用可见性。
  - 使用 desiredEdgeVisible/desiredSpaceVisible 与 isEdgeVisible/isSpaceVisible 做幂等状态机。
  - tickPhysics() 使用 spaceWindows 快照，隐藏时严格先停表后隐藏。
- MikuWindow：
  - 新增 stopAllActivities()；重写 close() 在关闭前停止计时器/移除观察者。
- AppSettings：
  - 提供边界/物理参数通知，支持帧率与屏幕范围选择。

### 升级指南
- 无破坏性改动；若有脚本读取版本，请同步读取 Info.plist 的 CFBundleShortVersionString（现为 1.1.0）。

---

## [1.0.0] - 2025-08-31
- 初始发布：沿挂与太空两种模式、基础拖拽/重力/弹跳、多屏与帧率设置、菜单栏控制等。

[1.1.0]: https://github.com/ink1ing/mikucat/releases/tag/v1.1.0
[1.2.0]: https://github.com/ink1ing/mikucat/releases/tag/v1.2.0
